<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Plot Twisted</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Bebas+Neue&family=Inter:wght@400;500;600;700&family=Special+Elite&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
/* ============================================
   PLOT TWISTED V2 - RETRO CINEMA AESTHETIC
   ============================================ */

:root {
    --bg-deep: #0a0a0f;
    --bg-dark: #12121a;
    --bg-card: #1a1a24;
    --bg-elevated: #242430;
    
    --gold-primary: #d4a853;
    --gold-light: #f0d078;
    --gold-dark: #a67c32;
    --gold-glow: rgba(212, 168, 83, 0.4);
    
    --red-primary: #c41e3a;
    --red-light: #e63950;
    --red-glow: rgba(196, 30, 58, 0.5);
    
    --cream: #f5f0e6;
    --cream-muted: #c9c4b8;
    --text-muted: #6b6b7b;
    
    --font-display: 'Playfair Display', serif;
    --font-title: 'Bebas Neue', sans-serif;
    --font-body: 'Inter', sans-serif;
    --font-typewriter: 'Special Elite', monospace;
    
    --shadow-glow: 0 0 30px var(--gold-glow);
    --shadow-deep: 0 10px 40px rgba(0,0,0,0.5);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

html, body {
    height: 100%;
    font-family: var(--font-body);
    background: var(--bg-deep);
    color: var(--cream);
    overflow: hidden;
    -webkit-tap-highlight-color: transparent;
}

/* Film Grain */
.film-grain {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 9999;
    opacity: 0.04;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
}

/* Screens */
.screen {
    display: none;
    position: fixed;
    inset: 0;
    flex-direction: column;
    opacity: 0;
    transition: opacity 0.4s ease;
}

.screen.active {
    display: flex;
    opacity: 1;
}

/* ============================================
   START SCREEN
   ============================================ */

#startScreen {
    background: 
        radial-gradient(ellipse at 50% 0%, rgba(212, 168, 83, 0.15) 0%, transparent 50%),
        radial-gradient(ellipse at 50% 100%, rgba(196, 30, 58, 0.1) 0%, transparent 40%),
        var(--bg-deep);
    justify-content: center;
    align-items: center;
    padding: 20px;
}

.marquee-frame {
    position: relative;
    padding: 40px 30px;
    max-width: 400px;
    width: 100%;
}

.marquee-frame::before,
.marquee-frame::after {
    content: '';
    position: absolute;
    width: 60px;
    height: 60px;
    border: 3px solid var(--gold-primary);
    opacity: 0.6;
}

.marquee-frame::before {
    top: 0;
    left: 0;
    border-right: none;
    border-bottom: none;
}

.marquee-frame::after {
    bottom: 0;
    right: 0;
    border-left: none;
    border-top: none;
}

.main-title {
    text-align: center;
    margin-bottom: 15px;
}

.title-plot {
    font-family: var(--font-display);
    font-size: clamp(3.5rem, 12vw, 5rem);
    font-weight: 900;
    color: var(--cream);
    letter-spacing: 0.02em;
    line-height: 0.9;
    text-shadow: 
        0 2px 0 var(--gold-dark),
        0 4px 0 rgba(0,0,0,0.3),
        0 0 40px var(--gold-glow);
}

.title-twisted {
    font-family: var(--font-title);
    font-size: clamp(2rem, 8vw, 3rem);
    color: var(--red-primary);
    letter-spacing: 0.3em;
    margin-top: -5px;
    text-shadow: 
        0 0 20px var(--red-glow),
        0 2px 0 rgba(0,0,0,0.5);
}

.tagline {
    font-family: var(--font-typewriter);
    font-size: 1rem;
    color: var(--cream-muted);
    text-align: center;
    margin-bottom: 40px;
    letter-spacing: 0.05em;
}

.divider {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    margin-bottom: 35px;
}

.divider-line {
    width: 50px;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--gold-primary), transparent);
}

.divider-star {
    color: var(--gold-primary);
    font-size: 0.8rem;
}

/* Buttons */
.btn {
    font-family: var(--font-body);
    font-weight: 600;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
    text-transform: uppercase;
    letter-spacing: 0.1em;
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn-play {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    width: 100%;
    padding: 18px 30px;
    font-size: 1.1rem;
    background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
    color: var(--bg-deep);
    border-radius: 4px;
    box-shadow: 0 4px 15px var(--gold-glow), inset 0 1px 0 rgba(255,255,255,0.2);
    margin-bottom: 15px;
}

.btn-play:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 6px 25px var(--gold-glow), inset 0 1px 0 rgba(255,255,255,0.2);
}

.btn-play:active { transform: translateY(0); }

.btn-play svg { width: 22px; height: 22px; }

.btn-secondary {
    width: 100%;
    padding: 14px 24px;
    font-size: 0.9rem;
    background: transparent;
    color: var(--cream-muted);
    border: 1px solid var(--text-muted);
    border-radius: 4px;
}

.btn-secondary:hover {
    border-color: var(--cream-muted);
    color: var(--cream);
}

.menu-row {
    display: flex;
    gap: 12px;
}

.btn-half {
    flex: 1;
}

.btn-quit {
    width: 36px;
    height: 36px;
    padding: 0;
    background: var(--bg-elevated);
    color: var(--cream-muted);
    border-radius: 50%;
    font-size: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-quit:hover {
    background: var(--red-primary);
    color: var(--cream);
}

/* Stats Bar */
.stats-bar {
    display: flex;
    justify-content: center;
    gap: 40px;
    margin-top: 50px;
    padding-top: 30px;
    border-top: 1px solid rgba(212, 168, 83, 0.2);
}

.stat-item { text-align: center; }

.stat-value {
    font-family: var(--font-display);
    font-size: 1.8rem;
    color: var(--gold-light);
}

.stat-label {
    font-size: 0.7rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.1em;
}

.home-quote-rotator {
    width: 100%;
}

#homeQuoteText,
#homeQuoteSource {
    text-align: center;
}

#homeQuoteSource {
    opacity: 0.8;
    font-size: 0.9em;
    margin-top: 4px;
}

/* ============================================
   CATEGORY SCREEN
   ============================================ */

#categoryScreen {
    background: var(--bg-deep);
    padding: 20px;
    overflow-y: auto;
}

.category-header {
    text-align: center;
    margin-bottom: 30px;
    padding-top: 20px;
}

.category-header h2 {
    font-family: var(--font-display);
    font-size: 2rem;
    color: var(--cream);
    margin-bottom: 8px;
}

.category-header p {
    font-size: 0.9rem;
    color: var(--text-muted);
}

.category-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    max-width: 500px;
    margin: 0 auto 100px;
}

.category-card {
    background: var(--bg-card);
    border: 2px solid var(--bg-elevated);
    border-radius: 12px;
    padding: 25px 15px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
}

.category-card:hover {
    border-color: var(--gold-dark);
    transform: translateY(-2px);
}

.category-card.selected {
    border-color: var(--gold-primary);
    box-shadow: 0 0 20px var(--gold-glow);
}

.category-emoji {
    font-size: 2.5rem;
    margin-bottom: 10px;
}

.category-name {
    font-family: var(--font-title);
    font-size: 1.2rem;
    color: var(--cream);
    letter-spacing: 0.1em;
    margin-bottom: 5px;
}

.category-count {
    font-size: 0.75rem;
    color: var(--text-muted);
}

.category-actions {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 20px;
    background: linear-gradient(to top, var(--bg-deep) 80%, transparent);
    display: flex;
    gap: 12px;
    max-width: 500px;
    margin: 0 auto;
}

.category-actions .btn {
    flex: 1;
    padding: 16px 24px;
    border-radius: 6px;
    font-size: 0.95rem;
}

.btn-back {
    background: var(--bg-elevated);
    color: var(--cream-muted);
}

.btn-start {
    background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
    color: var(--bg-deep);
    box-shadow: 0 4px 15px var(--gold-glow);
}

.btn-start:disabled {
    opacity: 0.4;
    cursor: not-allowed;
    transform: none;
}

/* ============================================
   GAME SCREEN
   ============================================ */

#gameScreen {
    background: var(--bg-deep);
}

.game-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    background: var(--bg-dark);
    border-bottom: 1px solid rgba(212, 168, 83, 0.2);
}

.game-logo {
    font-family: var(--font-display);
    font-size: 1.2rem;
    color: var(--gold-primary);
}

.game-stats {
    display: flex;
    gap: 25px;
}

.game-stat { text-align: center; }

.game-stat-label {
    font-size: 0.6rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.1em;
}

.game-stat-value {
    font-family: var(--font-title);
    font-size: 1.3rem;
    color: var(--cream);
}

.game-stat-value.points { color: var(--gold-light); }

.strikes-display {
    display: flex;
    gap: 4px;
}

.strike-pip {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--red-primary);
    box-shadow: 0 0 8px var(--red-glow);
    transition: all 0.3s ease;
}

.strike-pip.used {
    background: var(--bg-elevated);
    box-shadow: none;
}

.game-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 25px 20px;
    gap: 20px;
    overflow-y: auto;
}

/* Progress */
.progress-track {
    display: flex;
    gap: 8px;
}

.progress-pip {
    width: 12px;
    height: 4px;
    border-radius: 2px;
    background: var(--bg-elevated);
    transition: all 0.3s ease;
}

.progress-pip.complete { background: var(--gold-primary); }

.progress-pip.current {
    background: var(--gold-light);
    box-shadow: 0 0 10px var(--gold-glow);
    width: 24px;
}

/* Clue Card */
.clue-card {
    width: 100%;
    max-width: 500px;
    background: var(--bg-card);
    border: 1px solid rgba(212, 168, 83, 0.3);
    border-radius: 8px;
    padding: 30px 25px;
    position: relative;
    box-shadow: var(--shadow-deep);
}

.clue-card::before {
    content: '‚òÖ NOW SHOWING ‚òÖ';
    position: absolute;
    top: -12px;
    left: 50%;
    transform: translateX(-50%);
    font-family: var(--font-title);
    font-size: 0.75rem;
    color: var(--gold-primary);
    background: var(--bg-deep);
    padding: 4px 16px;
    letter-spacing: 0.2em;
}

.clue-text {
    font-family: var(--font-typewriter);
    font-size: 1.3rem;
    line-height: 1.7;
    text-align: center;
    color: var(--cream);
}

.clue-category {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid rgba(212, 168, 83, 0.15);
    font-size: 0.8rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.15em;
}

/* Points Pot */
.points-pot {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 12px 25px;
    background: var(--bg-card);
    border: 1px solid rgba(212, 168, 83, 0.3);
    border-radius: 50px;
}

.pot-label {
    font-size: 0.75rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.1em;
}

.pot-value {
    font-family: var(--font-display);
    font-size: 1.6rem;
    color: var(--gold-light);
    text-shadow: 0 0 15px var(--gold-glow);
    min-width: 60px;
    text-align: center;
}

.pot-value.dropping {
    animation: potDrop 0.3s ease;
}

@keyframes potDrop {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.15); color: var(--red-light); }
}

/* Title Reveal */
.title-reveal {
    width: 100%;
    max-width: 500px;
    min-height: 70px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    background: var(--bg-dark);
    border: 2px solid var(--bg-elevated);
    border-radius: 8px;
}

.title-letters {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 4px;
    font-family: var(--font-title);
    font-size: clamp(1.4rem, 5vw, 2rem);
    letter-spacing: 0.05em;
}

.letter-slot {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 0.7em;
    color: var(--gold-light);
    transition: all 0.3s ease;
}

.letter-slot.hidden { color: var(--text-muted); }

.letter-slot.revealed {
    animation: letterReveal 0.4s ease;
}

.letter-slot.space { width: 0.5em; }

@keyframes letterReveal {
    0% { transform: scale(1.5) rotateX(90deg); opacity: 0; }
    100% { transform: scale(1) rotateX(0); opacity: 1; }
}

/* Action Buttons */
.action-buttons {
    display: flex;
    gap: 12px;
    width: 100%;
    max-width: 500px;
}

.btn-reveal, .btn-giveup {
    flex: 1;
    padding: 16px 20px;
    font-size: 0.9rem;
    background: var(--bg-elevated);
    color: var(--cream);
    border-radius: 6px;
    border: 1px solid var(--text-muted);
}

.btn-reveal:hover:not(:disabled),
.btn-giveup:hover:not(:disabled) {
    background: var(--bg-card);
    border-color: var(--cream-muted);
}

.btn-reveal:disabled,
.btn-giveup:disabled {
    opacity: 0.4;
    cursor: not-allowed;
}

.btn-solve {
    flex: 1.5;
    padding: 16px 24px;
    font-size: 0.95rem;
    background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
    color: var(--bg-deep);
    border-radius: 6px;
    box-shadow: 0 4px 15px var(--gold-glow);
}

.btn-solve:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px var(--gold-glow);
}

.btn-solve:active { transform: translateY(0); }

.btn-solve:disabled {
    opacity: 0.4;
    cursor: not-allowed;
    transform: none;
}

/* ============================================
   MODALS
   ============================================ */

.modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.9);
    align-items: center;
    justify-content: center;
    z-index: 100;
    padding: 20px;
}

.modal-overlay.active { display: flex; }

.solve-modal {
    background: var(--bg-card);
    border: 1px solid rgba(212, 168, 83, 0.3);
    border-radius: 12px;
    padding: 30px;
    width: 100%;
    max-width: 400px;
    text-align: center;
}

.solve-modal h3 {
    font-family: var(--font-display);
    font-size: 1.5rem;
    color: var(--gold-light);
    margin-bottom: 20px;
}

.solve-input {
    width: 100%;
    padding: 16px;
    font-family: var(--font-body);
    font-size: 1.1rem;
    background: var(--bg-dark);
    border: 2px solid var(--bg-elevated);
    border-radius: 8px;
    color: var(--cream);
    text-align: center;
    margin-bottom: 20px;
}

.solve-input:focus {
    outline: none;
    border-color: var(--gold-primary);
}

.solve-input::placeholder { color: var(--text-muted); }

.solve-actions {
    display: flex;
    gap: 12px;
}

.solve-actions .btn {
    flex: 1;
    padding: 14px 20px;
    border-radius: 6px;
}

.btn-cancel {
    background: var(--bg-elevated);
    color: var(--cream-muted);
}

.btn-submit {
    background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
    color: var(--bg-deep);
}

/* Result Overlay */
.result-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.95);
    align-items: center;
    justify-content: center;
    z-index: 100;
    padding: 20px;
}

.result-overlay.active { display: flex; }

.result-card {
    text-align: center;
    max-width: 400px;
    position: relative;
}

.result-icon {
    font-size: 4rem;
    margin-bottom: 20px;
    animation: resultPop 0.5s ease;
}

@keyframes resultPop {
    0% { transform: scale(0); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}

.result-title {
    font-family: var(--font-display);
    font-size: 2.5rem;
    margin-bottom: 10px;
}

.result-title.correct {
    color: var(--gold-light);
    text-shadow: 0 0 30px var(--gold-glow);
}

.result-title.incorrect { color: var(--red-light); }

.result-movie {
    font-family: var(--font-title);
    font-size: 1.8rem;
    color: var(--cream);
    letter-spacing: 0.1em;
    margin-bottom: 10px;
}

.result-points {
    font-size: 1.1rem;
    color: var(--gold-primary);
    margin-bottom: 30px;
}

.result-points.zero { color: var(--text-muted); }

.btn-continue {
    padding: 16px 50px;
    font-size: 1rem;
    background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
    color: var(--bg-deep);
    border-radius: 6px;
    box-shadow: 0 4px 15px var(--gold-glow);
}

/* Celebration effect */
.result-card.celebrate::before {
    content: '‚ú®';
    position: absolute;
    font-size: 2rem;
    animation: sparkle 0.6s ease-out forwards;
    top: 20%;
    left: 20%;
}

.result-card.celebrate::after {
    content: '‚ú®';
    position: absolute;
    font-size: 2rem;
    animation: sparkle 0.6s ease-out 0.1s forwards;
    top: 20%;
    right: 20%;
}

@keyframes sparkle {
    0% { opacity: 0; transform: scale(0) rotate(0deg); }
    50% { opacity: 1; transform: scale(1.2) rotate(180deg); }
    100% { opacity: 0; transform: scale(0.5) rotate(360deg) translateY(-30px); }
}

/* ============================================
   GAME OVER SCREEN
   ============================================ */

#gameOverScreen {
    background: 
        radial-gradient(ellipse at 50% 30%, rgba(212, 168, 83, 0.1) 0%, transparent 50%),
        var(--bg-deep);
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.game-over-card {
    text-align: center;
    max-width: 400px;
    width: 100%;
}

.final-score-label {
    font-family: var(--font-title);
    font-size: 1rem;
    color: var(--text-muted);
    letter-spacing: 0.3em;
    margin-bottom: 10px;
}

.final-score {
    font-family: var(--font-display);
    font-size: 5rem;
    color: var(--gold-light);
    text-shadow: 0 0 40px var(--gold-glow);
    line-height: 1;
    margin-bottom: 5px;
}

.final-score-subtitle {
    font-size: 1rem;
    color: var(--cream-muted);
    margin-bottom: 40px;
}

.final-breakdown {
    background: var(--bg-card);
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 30px;
    border: 1px solid rgba(212, 168, 83, 0.2);
    max-height: 200px;
    overflow-y: auto;
}

.breakdown-row {
    display: flex;
    justify-content: space-between;
    padding: 10px 0;
    border-bottom: 1px solid var(--bg-elevated);
    font-size: 0.9rem;
}

.breakdown-row:last-child { border-bottom: none; }

.breakdown-title { color: var(--cream); }

.breakdown-points {
    font-family: var(--font-title);
    font-size: 1rem;
}

.breakdown-points.earned { color: var(--gold-primary); }
.breakdown-points.missed { color: var(--text-muted); }

.game-over-actions {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.game-over-actions .btn {
    width: 100%;
    padding: 16px 24px;
    border-radius: 6px;
}

.btn-play-again {
    background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
    color: var(--bg-deep);
    font-size: 1rem;
}

.btn-share {
    background: var(--bg-elevated);
    color: var(--cream);
    border: 1px solid var(--gold-dark);
}

.btn-menu {
    background: transparent;
    color: var(--cream-muted);
    border: 1px solid var(--text-muted);
}

/* ============================================
   HOW TO PLAY SCREEN
   ============================================ */

#howToPlayScreen {
    background: var(--bg-deep);
    padding: 20px;
    overflow-y: auto;
}

.how-to-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 30px;
    padding-top: 10px;
}

.how-to-header h2 {
    font-family: var(--font-display);
    font-size: 1.8rem;
    color: var(--cream);
}

.btn-back-small {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--bg-card);
    color: var(--cream);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    border: none;
    cursor: pointer;
}

.how-to-content {
    max-width: 500px;
    margin: 0 auto;
}

.how-to-section {
    margin-bottom: 30px;
}

.how-to-section h3 {
    font-family: var(--font-title);
    font-size: 1.1rem;
    color: var(--gold-primary);
    letter-spacing: 0.1em;
    margin-bottom: 10px;
}

.how-to-section p {
    color: var(--cream-muted);
    line-height: 1.7;
    font-size: 0.95rem;
}

/* Settings Screen */
.settings-content {
    max-width: 500px;
    margin: 0 auto;
    padding: 0 20px;
}

.settings-section {
    margin-bottom: 30px;
}

.settings-section h3 {
    font-family: var(--font-title);
    font-size: 0.9rem;
    color: var(--text-muted);
    letter-spacing: 0.15em;
    margin-bottom: 15px;
    text-transform: uppercase;
}

.setting-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background: var(--bg-card);
    border-radius: 8px;
    margin-bottom: 10px;
}

.setting-info {
    flex: 1;
}

.setting-label {
    font-weight: 500;
    color: var(--cream);
    margin-bottom: 3px;
}

.setting-desc {
    font-size: 0.8rem;
    color: var(--text-muted);
}

.toggle {
    width: 50px;
    height: 28px;
    background: var(--bg-elevated);
    border-radius: 14px;
    position: relative;
    cursor: pointer;
    transition: background 0.2s ease;
}

.toggle.active {
    background: var(--gold-primary);
}

.toggle::after {
    content: '';
    position: absolute;
    top: 3px;
    left: 3px;
    width: 22px;
    height: 22px;
    background: var(--cream);
    border-radius: 50%;
    transition: transform 0.2s ease;
}

.toggle.active::after {
    transform: translateX(22px);
}

.btn-reset {
    padding: 10px 20px;
    font-size: 0.85rem;
    background: var(--red-primary);
    color: var(--cream);
    border-radius: 6px;
}

.btn-reset:hover {
    background: var(--red-light);
}

.settings-about {
    color: var(--cream-muted);
    font-size: 0.9rem;
}

.settings-about a {
    color: var(--gold-primary);
    text-decoration: none;
}

.settings-about a:hover {
    text-decoration: underline;
}

/* Loading State */
.loading-overlay {
    position: fixed;
    inset: 0;
    background: var(--bg-deep);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    flex-direction: column;
    gap: 20px;
}

.loading-overlay.hidden {
    display: none;
}

.loading-spinner {
    width: 50px;
    height: 50px;
    border: 3px solid var(--bg-elevated);
    border-top-color: var(--gold-primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.loading-text {
    font-family: var(--font-typewriter);
    color: var(--cream-muted);
}

/* Animations */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.fade-in { animation: fadeIn 0.4s ease forwards; }

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    20%, 60% { transform: translateX(-8px); }
    40%, 80% { transform: translateX(8px); }
}

.shake { animation: shake 0.4s ease; }
    </style>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
<script>
  window.dataLayer=window.dataLayer||[];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config','G-XXXXXXXXXX');
</script>
<script>
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>navigator.serviceWorker.register('/sw.js'));
}
</script>

</head>
<body>
    <div class="film-grain"></div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading clues...</div>
    </div>

    <!-- START SCREEN -->
    <div id="startScreen" class="screen active">
        <div class="marquee-frame">
            <div class="main-title">
                <div class="title-plot">PLOT</div>
                <div class="title-twisted">TWISTED</div>
            </div>
            <p class="tagline">Guess the movie from the twisted summary</p>
            <div class="divider">
                <span class="divider-line"></span>
                <span class="divider-star">‚òÖ</span>
                <span class="divider-line"></span>
            </div>
            <button class="btn btn-play" id="playBtn" disabled>
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                Start Playing
            </button>
            <div class="menu-row">
                <button class="btn btn-secondary btn-half" id="howToPlayBtn">How to Play</button>
                <button class="btn btn-secondary btn-half" id="settingsBtn">Settings</button>
            </div>
            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-value" id="statSolved">0</div>
                    <div class="stat-label">Solved</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statAccuracy">0%</div>
                    <div class="stat-label">Accuracy</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statStreak">0</div>
                    <div class="stat-label">Best Streak</div>
                </div>
                <div id="homeQuoteRotator" class="home-quote-rotator">
                    <div id="homeQuoteText"></div>
                    <div id="homeQuoteSource"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- CATEGORY SCREEN -->
    <div id="categoryScreen" class="screen">
        <div class="category-header">
            <h2>Choose Your Genre</h2>
            <p>Pick a category to start playing</p>
        </div>
        <div class="category-grid" id="categoryGrid"></div>
        <div class="category-actions">
            <button class="btn btn-back" id="categoryBackBtn">Back</button>
            <button class="btn btn-start" id="startGameBtn" disabled>Start</button>
        </div>
    </div>

    <!-- HOW TO PLAY SCREEN -->
    <div id="howToPlayScreen" class="screen">
        <div class="how-to-header">
            <button class="btn-back-small" id="howToBackBtn">‚Üê</button>
            <h2>How to Play</h2>
        </div>
        <div class="how-to-content">
            <div class="how-to-section">
                <h3>üé¨ The Goal</h3>
                <p>Read the twisted (but technically accurate) plot summary and guess the movie title. The faster you solve it, the more points you earn!</p>
            </div>
            <div class="how-to-section">
                <h3>üí∞ Scoring</h3>
                <p>Each movie starts at 500 points. Every letter you reveal costs 50 points. Solve early for maximum score, or reveal letters if you're stuck.</p>
            </div>
            <div class="how-to-section">
                <h3>‚ùå Strikes</h3>
                <p>You have 3 strikes for the entire game. Wrong guesses cost a strike. Run out and it's game over!</p>
            </div>
            <div class="how-to-section">
                <h3>üè≥Ô∏è Give Up</h3>
                <p>Completely stumped? Hit "Give Up" to see the answer and move on with zero points for that round.</p>
            </div>
        </div>
    </div>

    <!-- SETTINGS SCREEN -->
    <div id="settingsScreen" class="screen">
        <div class="how-to-header">
            <button class="btn-back-small" id="settingsBackBtn">‚Üê</button>
            <h2>Settings</h2>
        </div>
        <div class="settings-content">
            <div class="settings-section">
                <h3>Game Options</h3>
                <div class="setting-row">
                    <div class="setting-info">
                        <div class="setting-label">Sound Effects</div>
                        <div class="setting-desc">Play sounds for correct/incorrect</div>
                    </div>
                    <div class="toggle" id="soundToggle"></div>
                </div>
                <div class="setting-row">
                    <div class="setting-info">
                        <label class="setting-label" for="roastModeSelect">Roast Intensity</label>
                        <div class="setting-desc">Choose how spicy the feedback gets</div>
                    </div>
                    <select id="roastModeSelect">
                        <option value="clean">Clean</option>
                        <option value="spicy">Spicy</option>
                        <option value="nsfw">NSFW</option>
                    </select>
                </div>
            </div>
            <div class="settings-section">
                <h3>Data</h3>
                <div class="setting-row">
                    <div class="setting-info">
                        <div class="setting-label">Reset Progress</div>
                        <div class="setting-desc">Clear all stats and seen clues</div>
                    </div>
                    <button class="btn btn-reset" id="resetBtn">Reset</button>
                </div>
            </div>
            <div class="settings-section">
                <h3>About</h3>
                <p class="settings-about">Created by <a href="https://x.com/Ben_Soup" target="_blank">Ben Campbell</a></p>
            </div>
        </div>
    </div>

    <!-- GAME SCREEN -->
    <div id="gameScreen" class="screen">
        <div class="game-header">
            <div class="game-logo">Plot Twisted</div>
            <div class="game-stats">
                <div class="game-stat">
                    <div class="game-stat-label">Score</div>
                    <div class="game-stat-value points" id="totalScore">0</div>
                </div>
                <div class="game-stat">
                    <div class="game-stat-label">Strikes</div>
                    <div class="strikes-display" id="strikesDisplay">
                        <div class="strike-pip"></div>
                        <div class="strike-pip"></div>
                        <div class="strike-pip"></div>
                    </div>
                </div>
            </div>
            <button class="btn btn-quit" id="quitBtn">‚úï</button>
        </div>
        <div class="game-content">
            <div class="progress-track" id="progressTrack"></div>
            <div class="clue-card fade-in" id="clueCard">
                <div class="clue-text" id="clueText"></div>
                <div class="clue-category" id="clueCategory"></div>
            </div>
            <div class="points-pot">
                <span class="pot-label">Worth</span>
                <span class="pot-value" id="potValue">500</span>
            </div>
            <div class="title-reveal" id="titleReveal">
                <div class="title-letters" id="titleLetters"></div>
            </div>
            <div class="action-buttons">
                <button class="btn btn-reveal" id="revealBtn">Reveal Letter</button>
                <button class="btn btn-giveup" id="giveUpBtn">Give Up</button>
                <button class="btn btn-solve" id="solveBtn">I Know It!</button>
            </div>
        </div>
    </div>

    <!-- GAME OVER SCREEN -->
    <div id="gameOverScreen" class="screen">
        <div class="game-over-card">
            <div class="final-score-label">FINAL SCORE</div>
            <div class="final-score" id="finalScore">0</div>
            <div class="final-score-subtitle" id="finalSubtitle">5 of 5 movies solved</div>
            <div class="final-breakdown" id="finalBreakdown"></div>
            <div class="game-over-actions">
                <button class="btn btn-play-again" id="playAgainBtn">Play Again</button>
                <button class="btn btn-share" id="shareBtn">Share Score</button>
                <button class="btn btn-menu" id="menuBtn">Main Menu</button>
            </div>
        </div>
    </div>

    <!-- SOLVE MODAL -->
    <div class="modal-overlay" id="solveModal">
        <div class="solve-modal">
            <h3>What's the movie?</h3>
            <input type="text" class="solve-input" id="solveInput" placeholder="Type your answer..." autocomplete="off" autocapitalize="off">
            <div class="solve-actions">
                <button class="btn btn-cancel" id="cancelSolveBtn">Cancel</button>
                <button class="btn btn-submit" id="submitSolveBtn">Submit</button>
            </div>
        </div>
    </div>

    <!-- QUIT CONFIRMATION MODAL -->
    <div class="modal-overlay" id="quitModal">
        <div class="solve-modal">
            <h3>Quit Game?</h3>
            <p style="color: var(--cream-muted); margin-bottom: 20px;">Your progress will be lost.</p>
            <div class="solve-actions">
                <button class="btn btn-cancel" id="cancelQuitBtn">Cancel</button>
                <button class="btn btn-submit" id="confirmQuitBtn">Quit</button>
            </div>
        </div>
    </div>

    <!-- RESULT OVERLAY -->
    <div class="result-overlay" id="resultOverlay">
        <div class="result-card">
            <div class="result-icon" id="resultIcon">üé¨</div>
            <div class="result-title" id="resultTitle">Correct!</div>
            <div class="result-movie" id="resultMovie">TITANIC</div>
            <div class="result-points" id="resultPoints">+500 points</div>
            <button class="btn btn-continue" id="continueBtn">Continue</button>
        </div>
    </div>

<script>
// ============================================
// CATEGORY METADATA (emojis only - clues load from JSON)
// ============================================

const CATEGORY_META = {
    "Family": { emoji: "üéà" },
    "Sci-Fi": { emoji: "üß†" },
    "Fantasy": { emoji: "üí´" },
    "Superhero": { emoji: "ü¶∏" },
    "Emotional Damage": { emoji: "üíî" },
    "Streaming Hits": { emoji: "üì∫" }
};

const HOME_QUOTES = [
    { quote: "May the Force be with you.", source: "Star Wars" },
    { quote: "I‚Äôm gonna make him an offer he can‚Äôt refuse.", source: "The Godfather" },
    { quote: "Here‚Äôs looking at you, kid.", source: "Casablanca" },
    { quote: "Why so serious?", source: "The Dark Knight" },
    { quote: "You can‚Äôt handle the truth!", source: "A Few Good Men" },
    { quote: "I‚Äôll be back.", source: "The Terminator" },
    { quote: "To infinity and beyond!", source: "Toy Story" },
    { quote: "My precious.", source: "The Lord of the Rings" },
    { quote: "Life finds a way.", source: "Jurassic Park" },
    { quote: "I see dead people.", source: "The Sixth Sense" },
    { quote: "Just keep swimming.", source: "Finding Nemo" },
    { quote: "You‚Äôre gonna need a bigger boat.", source: "Jaws" },
    { quote: "Roads? Where we‚Äôre going we don‚Äôt need roads.", source: "Back to the Future" },
    { quote: "I am your father.", source: "Star Wars: The Empire Strikes Back" },
    { quote: "I volunteer as tribute!", source: "The Hunger Games" },
    { quote: "Wakanda forever!", source: "Black Panther" },
    { quote: "With great power comes great responsibility.", source: "Spider-Man" },
    { quote: "Hakuna Matata.", source: "The Lion King" },
    { quote: "I‚Äôm the king of the world!", source: "Titanic" },
    { quote: "Keep your friends close, but your enemies closer.", source: "The Godfather Part II" },
    { quote: "Houston, we have a problem.", source: "Apollo 13" },
    { quote: "You had me at hello.", source: "Jerry Maguire" },
    { quote: "There‚Äôs no place like home.", source: "The Wizard of Oz" },
    { quote: "I drink your milkshake!", source: "There Will Be Blood" },
    { quote: "Show me the money!", source: "Jerry Maguire" }
];

// ============================================
// COMMENTARY BANK
// ============================================

const PRAISE_MESSAGES = {
    clean: [
        "You guessed that like you‚Äôve seen it 47 times.",
        "Cinema brain activated. Nice pull.",
        "You didn‚Äôt just get it right, you got it efficiently right.",
        "Textbook. If there were a textbook for this, you‚Äôd be in it.",
        "Critics could never compete with that level of recall.",
        "You and this movie clearly have unfinished business.",
        "That was so fast I‚Äôm checking for spoilers on your forehead.",
        "Streaming services fear how quickly you recognized that.",
        "Someone‚Äôs been paying attention instead of scrolling their phone.",
        "You didn‚Äôt guess. You *remembered*.",
        "That answer landed smoother than a perfect opening weekend.",
        "IMDb just got nervous about their job security.",
        "Award-winning stuff right there. At least in this game.",
        "Your movie memory is doing heavy lifting today.",
        "You saw one vague clue and said, ‚ÄòI know that trauma.‚Äô",
        "That was main-character-energy accurate.",
        "You solved that like it was the trailer and you‚Äôd already bought tickets.",
        "If this were trivia night, your team would be buying you snacks.",
        "Perfect answer. Somewhere a director just felt validated.",
        "You didn‚Äôt even hesitate. Iconic behavior."
    ],
    spicy: [
        "Okay, film buff. Touch grass later, maybe?",
        "Be honest, how many times have you rewatched this instead of sleeping?",
        "You nailed it so fast I‚Äôm a little concerned for your social life.",
        "Your brain is 70% water, 30% movie quotes.",
        "Therapist: ‚ÄòHow often do you think about this movie?‚Äô You:",
        "That was suspiciously fast. Are you secretly the director?",
        "You got that right like you‚Äôve been emotionally damaged by it for years.",
        "Your recall is terrifying in a ‚Äòplease join my trivia team‚Äô way.",
        "You really said, ‚ÄòOh, that‚Äôs my Roman Empire.‚Äô",
        "The way you snapped that answer out‚Ä¶ stay dangerous.",
        "You‚Äôre not just online. You *live* in the fandom.",
        "That was a speedrun. Any percent. No glitches.",
        "Some people have hobbies; you have hyper-specific movie knowledge.",
        "You got it right, and honestly? I expected nothing less from you.",
        "Your brain: a carefully curated library of oddly specific plots."
    ],
    nsfw: [
        "Well damn, you didn‚Äôt even let the clue breathe.",
        "Jesus, you smoked that answer like it owed you money.",
        "Okay, calm down, Rotten Tomatoes, we get it‚Äîyou know your shit.",
        "That was so fast it felt a little illegal.",
        "You didn‚Äôt guess. You **absolutely knew**. And frankly? Terrifying.",
        "You answered that like this movie personally ruined your mental health.",
        "Alright, trivia gremlin, go touch some daylight after this.",
        "You cooked that answer. No notes. Just unhinged talent.",
        "That was disrespectfully accurate. The movie didn‚Äôt stand a chance.",
        "You hit that one like a spoiler in group chat on release day.",
        "Your brain is just a cursed archive of movie trauma and I respect it.",
        "You didn‚Äôt even blink. Are you okay? Blink twice if not.",
        "You grabbed that answer by the throat and made it your own.",
        "If knowledge is power, you‚Äôre one bad day away from villain origin.",
        "That was feral-level correct. Proud of you, slightly afraid of you."
    ]
};

const INSULT_MESSAGES = {
    clean: [
        "Strong start, wrong universe.",
        "Close, but the multiverse says no.",
        "Somewhere, a film professor just sighed softly.",
        "Not quite. Spirit of the answer? Maybe. Points? Absolutely not.",
        "That guess is going straight to the cutting room floor.",
        "Good energy, incorrect timeline.",
        "Nice confidence. Shame about the accuracy.",
        "Bold of you to answer so wrong so fast.",
        "You aimed for Oscar season and landed in straight-to-DVD.",
        "Plot twist: that‚Ä¶ was not it.",
        "You and the right answer are on different streaming platforms.",
        "The vibes were there. The title was not.",
        "If points were given for enthusiasm, you‚Äôd be thriving.",
        "That answer needs a reboot.",
        "You missed, but in a very watchable way.",
        "Honestly? I‚Äôve seen worse guesses. Not many. But some.",
        "Wrong, but at least you committed.",
        "That guess was like a bad sequel‚Äîtechnically connects, but still no.",
        "We‚Äôll file that under ‚Äòcreative interpretations.‚Äô",
        "It‚Äôs okay. Every flop era builds character."
    ],
    spicy: [
        "You didn‚Äôt miss by a mile, you missed by a franchise.",
        "That answer belongs in the bargain bin at a gas station.",
        "You shot your shot and hit the neighbor‚Äôs Wi-Fi instead.",
        "Peak confidence, zero correctness.",
        "You really said, ‚ÄòI haven‚Äôt healed, but I will guess anyway.‚Äô",
        "I see the vision, but the vision is blindfolded.",
        "If wrong answers were streaming, you‚Äôd be trending.",
        "That guess was fanfic at best.",
        "You‚Äôre not even in the same cinematic universe, my friend.",
        "That was a popcorn kernel of a guess. All crunch, no substance.",
        "The way you swerved around the correct answer should be illegal.",
        "You typed that like it was right. It was not.",
        "Your answer has strong ‚Äòfirst draft‚Äô energy.",
        "If this were a director‚Äôs cut, your guess would be the deleted scene.",
        "You didn‚Äôt just miss; you created a whole new genre of wrong."
    ],
    nsfw: [
        "You didn‚Äôt just miss‚Äîthat answer got dragged into the alley and jumped.",
        "That was so wrong I had to check if we‚Äôre even playing the same game.",
        "Your guess just got ratio‚Äôd by the correct answer.",
        "That answer was a full-on disaster. Like, director-apologizes-on-Twitter bad.",
        "You missed so hard the plot filed a restraining order.",
        "That guess was straight-up fanfiction with none of the tags right.",
        "If wrong answers were crimes, you‚Äôd be wanted in three countries.",
        "You cooked that guess, but the stove wasn‚Äôt even on.",
        "I‚Äôve seen spoilers less offensive than that answer.",
        "Your accuracy just rage-quit the session.",
        "That guess was so off I‚Äôm checking your controller for drift.",
        "You didn‚Äôt fumble the bag; you launched it into orbit.",
        "That was not it, chief. Or deputy. Or background extra.",
        "If there were achievements for being wrong, you‚Äôd just unlocked a legendary.",
        "You and the right answer are not just distant‚Äîyou‚Äôre in different tax brackets."
    ]
};

// ============================================
// GAME ENGINE
// ============================================

class PlotTwisted {
    constructor() {
        this.state = {
            currentScreen: 'start',
            selectedCategory: null,
            questions: [],
            currentIndex: 0,
            totalScore: 0,
            strikes: 3,
            currentPot: 500,
            revealedIndices: [],
            results: [],
            seenClues: {}
        };
        
        this.config = {
            maxPot: 500,
            revealCost: 50,
            minPot: 50,
            questionsPerRound: 5,
            fuzzyThreshold: 0.18
        };
        
        this.clueBank = null;
        this.stats = this.loadStats();
        this.quoteInterval = null;
        this.quoteIndex = 0;
    }

    async init() {
        this.cacheDOM();
        this.bindEvents();
        this.hideTrackingUI();
        this.loadSeenClues();
        this.loadSettings();
        this.updateStatsDisplay();
        
        await this.loadClueDatabase();
        
        this.showScreen('start');
    }
    
    async loadClueDatabase() {
        try {
            const response = await fetch('./clues.json');
            if (!response.ok) throw new Error('Failed to load clues');
            this.clueBank = await response.json();
            
            document.getElementById('playBtn').disabled = false;
            document.getElementById('loadingOverlay').classList.add('hidden');
            
            console.log('‚úÖ Clue database loaded:', Object.keys(this.clueBank));
        } catch (err) {
            console.error("‚ùå Clues failed to load:", err);
            document.querySelector('.loading-text').textContent = 'Failed to load. Please refresh.';
        }
    }
    
    loadSettings() {
        const saved = localStorage.getItem('plotTwistedSettings');
        this.settings = this.safeJsonParse(saved, { sound: false, roastMode: 'clean' }, 'settings');
        if (!Object.prototype.hasOwnProperty.call(this.settings, 'sound')) {
            this.settings.sound = false;
        }
        if (!Object.prototype.hasOwnProperty.call(this.settings, 'roastMode')) {
            this.settings.roastMode = 'clean';
        }
        this.dom.soundToggle.classList.toggle('active', this.settings.sound);
        if (this.dom.roastModeSelect) {
            this.dom.roastModeSelect.value = this.settings.roastMode;
        }
        this.saveSettings();
    }

    saveSettings() {
        localStorage.setItem('plotTwistedSettings', JSON.stringify(this.settings));
    }

    safeJsonParse(raw, fallback, label) {
        if (!raw) return fallback;
        try {
            const parsed = JSON.parse(raw);
            return parsed ?? fallback;
        } catch (err) {
            console.warn(`‚ö†Ô∏è Invalid ${label} data in localStorage. Resetting to defaults.`, err);
            return fallback;
        }
    }

    cacheDOM() {
        this.screens = {
            start: document.getElementById('startScreen'),
            category: document.getElementById('categoryScreen'),
            howToPlay: document.getElementById('howToPlayScreen'),
            settings: document.getElementById('settingsScreen'),
            game: document.getElementById('gameScreen'),
            gameOver: document.getElementById('gameOverScreen')
        };
        
        this.dom = {
            statSolved: document.getElementById('statSolved'),
            statAccuracy: document.getElementById('statAccuracy'),
            statStreak: document.getElementById('statStreak'),
            categoryGrid: document.getElementById('categoryGrid'),
            startGameBtn: document.getElementById('startGameBtn'),
            clueText: document.getElementById('clueText'),
            clueCategory: document.getElementById('clueCategory'),
            clueCard: document.getElementById('clueCard'),
            titleLetters: document.getElementById('titleLetters'),
            potValue: document.getElementById('potValue'),
            totalScore: document.getElementById('totalScore'),
            strikesDisplay: document.getElementById('strikesDisplay'),
            progressTrack: document.getElementById('progressTrack'),
            revealBtn: document.getElementById('revealBtn'),
            giveUpBtn: document.getElementById('giveUpBtn'),
            solveBtn: document.getElementById('solveBtn'),
            solveModal: document.getElementById('solveModal'),
            solveInput: document.getElementById('solveInput'),
            quitModal: document.getElementById('quitModal'),
            resultOverlay: document.getElementById('resultOverlay'),
            resultIcon: document.getElementById('resultIcon'),
            resultTitle: document.getElementById('resultTitle'),
            resultMovie: document.getElementById('resultMovie'),
            resultPoints: document.getElementById('resultPoints'),
            continueBtn: document.getElementById('continueBtn'),
            soundToggle: document.getElementById('soundToggle'),
            roastModeSelect: document.getElementById('roastModeSelect'),
            finalScore: document.getElementById('finalScore'),
            finalSubtitle: document.getElementById('finalSubtitle'),
            finalBreakdown: document.getElementById('finalBreakdown'),
            homeQuoteRotator: document.getElementById('homeQuoteRotator'),
            homeQuoteText: document.getElementById('homeQuoteText'),
            homeQuoteSource: document.getElementById('homeQuoteSource'),
            resetBtn: document.getElementById('resetBtn')
        };
    }

    bindEvents() {
        const onClick = (id, handler) => {
            const el = document.getElementById(id);
            if (el) el.onclick = handler;
        };

        onClick('playBtn', () => this.showCategoryScreen());
        onClick('howToPlayBtn', () => this.showScreen('howToPlay'));
        onClick('howToBackBtn', () => this.showScreen('start'));
        onClick('settingsBtn', () => this.showScreen('settings'));
        onClick('settingsBackBtn', () => this.showScreen('start'));
        
        if (this.dom.soundToggle) {
            this.dom.soundToggle.onclick = () => this.toggleSound();
        }
        if (this.dom.roastModeSelect) {
            this.dom.roastModeSelect.addEventListener('change', (event) => {
                this.handleRoastModeChange(event.target.value);
            });
        }
        if (this.dom.resetBtn) {
            this.dom.resetBtn.onclick = () => this.resetProgress();
        }
        
        onClick('categoryBackBtn', () => this.showScreen('start'));
        if (this.dom.startGameBtn) {
            this.dom.startGameBtn.onclick = () => this.startGame();
        }
        
        if (this.dom.revealBtn) {
            this.dom.revealBtn.onclick = () => this.revealLetter();
        }
        if (this.dom.giveUpBtn) {
            this.dom.giveUpBtn.onclick = () => this.giveUp();
        }
        if (this.dom.solveBtn) {
            this.dom.solveBtn.onclick = () => this.openSolveModal();
        }
        
        onClick('quitBtn', () => this.dom.quitModal?.classList.add('active'));
        onClick('cancelQuitBtn', () => this.dom.quitModal?.classList.remove('active'));
        onClick('confirmQuitBtn', () => this.confirmQuit());
        
        onClick('cancelSolveBtn', () => this.closeSolveModal());
        onClick('submitSolveBtn', () => this.submitSolve());
        if (this.dom.solveInput) {
            this.dom.solveInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.submitSolve();
                }
            });
        }
        
        onClick('playAgainBtn', () => this.playAgain());
        onClick('shareBtn', () => this.shareScore());
        onClick('menuBtn', () => this.showScreen('start'));
    }
    
    toggleSound() {
        this.settings = this.settings || { sound: false };
        this.settings.sound = !this.settings.sound;
        this.dom.soundToggle.classList.toggle('active', this.settings.sound);
        this.saveSettings();
    }

    handleRoastModeChange(mode) {
        if (mode === 'nsfw') {
            const ok = window.confirm(
                'NSFW mode includes explicit language and stronger roasts. Are you sure you want to enable it?'
            );
            if (!ok) {
                if (this.dom.roastModeSelect) {
                    this.dom.roastModeSelect.value = this.settings.roastMode || 'clean';
                }
                return;
            }
        }

        this.settings.roastMode = mode;
        this.saveSettings();
    }
    
    resetProgress() {
        if (confirm('Are you sure? This will clear all your stats and seen clues.')) {
            localStorage.removeItem('plotTwistedStats');
            localStorage.removeItem('plotTwistedSeen');
            this.stats = this.loadStats();
            this.state.seenClues = {};
            this.updateStatsDisplay();
            this.showScreen('start');
        }
    }
    
    confirmQuit() {
        this.dom.quitModal.classList.remove('active');
        this.showScreen('start');
    }

    showScreen(name) {
        Object.values(this.screens).forEach(s => s.classList.remove('active'));
        this.screens[name]?.classList.add('active');
        this.state.currentScreen = name;

        if (name === 'start') {
            this.startHomeQuoteRotator();
        } else {
            this.stopHomeQuoteRotator();
        }
    }

    showCategoryScreen() {
        this.renderCategories();
        this.state.selectedCategory = null;
        this.dom.startGameBtn.disabled = true;
        this.showScreen('category');
    }

    renderCategories() {
        if (!this.clueBank) return;
        
        this.dom.categoryGrid.innerHTML = '';
        
        Object.keys(this.clueBank).forEach(name => {
            const card = document.createElement('div');
            card.className = 'category-card';
            card.dataset.category = name;
            
            const clues = this.clueBank[name];
            const unseenCount = this.getUnseenCount(name);
            const emoji = CATEGORY_META[name]?.emoji || 'üé¨';
            
            card.innerHTML = `
                <div class="category-emoji">${emoji}</div>
                <div class="category-name">${name}</div>
                <div class="category-count" style="display: none;">${unseenCount} unseen / ${clues.length} total</div>
            `;
            
            card.onclick = () => this.selectCategory(name);
            this.dom.categoryGrid.appendChild(card);
        });
    }

    selectCategory(name) {
        document.querySelectorAll('.category-card').forEach(c => c.classList.remove('selected'));
        document.querySelector(`.category-card[data-category="${name}"]`)?.classList.add('selected');
        this.state.selectedCategory = name;
        this.dom.startGameBtn.disabled = false;
    }

    startGame() {
        const category = this.state.selectedCategory;
        const allClues = this.clueBank?.[category];

        if (!category || !allClues || allClues.length === 0) {
            console.error('No clues available for selected category:', category);
            alert('No clues available for that category yet. Please choose another.');
            return;
        }
        
        const seenTitles = this.state.seenClues[category] || [];
        
        const unseenClues = allClues.filter(c => !seenTitles.includes(c.title));
        const seenClues = allClues.filter(c => seenTitles.includes(c.title));
        
        let pool = this.shuffle(unseenClues);
        if (pool.length < this.config.questionsPerRound) {
            pool = [...pool, ...this.shuffle(seenClues)];
        }
        
        this.state.questions = pool.slice(0, this.config.questionsPerRound);
        
        if (!this.state.seenClues[category]) {
            this.state.seenClues[category] = [];
        }
        this.state.questions.forEach(q => {
            if (!this.state.seenClues[category].includes(q.title)) {
                this.state.seenClues[category].push(q.title);
            }
        });
        this.saveSeenClues();
        
        this.state.currentIndex = 0;
        this.state.totalScore = 0;
        this.state.results = [];
        
        this.renderProgress();
        this.updateTotalScore();
        
        this.showScreen('game');
        this.loadQuestion();
    }

    loadQuestion() {
        const q = this.state.questions[this.state.currentIndex];
        
        this.state.strikes = 3;
        this.state.currentPot = this.config.maxPot;
        this.state.revealedIndices = [];
        
        this.dom.clueText.textContent = q.clue;
        this.dom.clueCategory.textContent = this.state.selectedCategory;
        this.updatePot();
        this.updateStrikes();
        this.updateProgress();
        this.renderTitle();
    }

    renderTitle() {
        const q = this.state.questions[this.state.currentIndex];
        const displayTitle = this.getDisplayTitle(q.title).toUpperCase();
        
        this.dom.titleLetters.innerHTML = '';
        
        displayTitle.split('').forEach((char, i) => {
            const slot = document.createElement('span');
            slot.className = 'letter-slot';
            
            if (char === ' ') {
                slot.classList.add('space');
                slot.textContent = '';
            } else if (/[A-Z0-9]/.test(char)) {
                if (this.state.revealedIndices.includes(i)) {
                    slot.textContent = char;
                    slot.classList.add('revealed');
                } else {
                    slot.textContent = '_';
                    slot.classList.add('hidden');
                }
            } else {
                slot.textContent = char;
            }
            
            this.dom.titleLetters.appendChild(slot);
        });
    }

    levenshtein(a, b) {
        const matrix = [];
        for (let i = 0; i <= b.length; i++) matrix[i] = [i];
        for (let j = 0; j <= a.length; j++) matrix[0][j] = j;

        for (let i = 1; i <= b.length; i++) {
            for (let j = 1; j <= a.length; j++) {
                if (b.charAt(i - 1) === a.charAt(j - 1)) {
                    matrix[i][j] = matrix[i - 1][j - 1];
                } else {
                    matrix[i][j] = Math.min(
                        matrix[i - 1][j - 1] + 1,
                        matrix[i][j - 1] + 1,
                        matrix[i - 1][j] + 1
                    );
                }
            }
        }
        return matrix[b.length][a.length];
    }

    normalizeTitle(str) {
        return str
            .toLowerCase()
            .replace(/\([^)]*\)/g, '')
            .replace(/^the\s+/g, '')
            .replace(/[^a-z0-9]/g, ' ')
            .replace(/\s+/g, ' ')
            .trim();
    }

    getDisplayTitle(title) {
        return title.replace(/\([^)]*\)/g, '').trim();
    }

    isFuzzyMatch(guess, actual) {
        const g = this.normalizeTitle(guess);
        const a = this.normalizeTitle(actual);

        if (!g) return false;
        if (g === a) return true;

        const distance = this.levenshtein(g, a);
        const maxErrors = Math.floor(a.length * this.config.fuzzyThreshold);
        
        return distance <= Math.max(1, maxErrors);
    }
    
    revealLetter() {
        const q = this.state.questions[this.state.currentIndex];
        const displayTitle = this.getDisplayTitle(q.title).toUpperCase();

        // Collect all revealable letter indices (A‚ÄìZ, 0‚Äì9)
        const allLetterIndices = [];
        displayTitle.split('').forEach((char, i) => {
            if (/[A-Z0-9]/.test(char)) {
                allLetterIndices.push(i);
            }
        });

        const totalLetters = allLetterIndices.length;

        // Build list of currently hidden indices
        const hiddenIndices = allLetterIndices.filter(
            i => !this.state.revealedIndices.includes(i)
        );

        // If nothing left to reveal, bail
        if (hiddenIndices.length === 0) return;

        // SPECIAL CASE: very short titles (3 letters or fewer)
        // For these, allow full reveal like before.
        if (totalLetters <= 3) {
            const randomIndex = hiddenIndices[Math.floor(Math.random() * hiddenIndices.length)];
            this.state.revealedIndices.push(randomIndex);

            this.state.currentPot = Math.max(this.config.minPot, this.state.currentPot - this.config.revealCost);
            this.updatePot(true);
            this.renderTitle();

            // If that was the last hidden letter, you can still auto-solve if desired
            if (hiddenIndices.length <= 1) {
                this.autoSolve();
            }

            return;
        }

        // NORMAL CASE: longer titles
        // Always leave at least 2 letters unrevealed.
        // If revealing another letter would drop hidden letters below 2, stop.
        if (hiddenIndices.length <= 2) {
            // Already at 2 or fewer hidden letters; do not reveal more via hints.
            return;
        }

        // Safe to reveal one random hidden letter
        const randomIndex = hiddenIndices[Math.floor(Math.random() * hiddenIndices.length)];
        this.state.revealedIndices.push(randomIndex);

        this.state.currentPot = Math.max(this.config.minPot, this.state.currentPot - this.config.revealCost);
        this.updatePot(true);
        this.renderTitle();

        // Do NOT call autoSolve here in the normal case.
    }

    autoSolve() {
        const q = this.state.questions[this.state.currentIndex];
        const points = this.state.currentPot;
        
        const displayTitle = this.getDisplayTitle(q.title).toUpperCase();
        displayTitle.split('').forEach((char, i) => {
            if (/[A-Z0-9]/.test(char) && !this.state.revealedIndices.includes(i)) {
                this.state.revealedIndices.push(i);
            }
        });
        this.renderTitle();
        
        this.state.results.push({ title: q.title, points, correct: true });
        this.state.totalScore += points;
        this.updateTotalScore();
        this.showResult(true, q.title, points);
    }

    giveUp() {
        const q = this.state.questions[this.state.currentIndex];
        
        this.state.results.push({ title: q.title, points: 0, correct: false, gaveUp: true });
        
        const displayTitle = this.getDisplayTitle(q.title).toUpperCase();
        displayTitle.split('').forEach((char, i) => {
            if (/[A-Z0-9]/.test(char)) {
                this.state.revealedIndices.push(i);
            }
        });
        this.renderTitle();
        
        this.showResult(false, q.title, 0, false, true);
    }

    openSolveModal() {
        this.dom.solveModal.classList.add('active');
        this.dom.solveInput.value = '';
        requestAnimationFrame(() => {
            this.dom.solveInput?.focus({ preventScroll: true });
        });
    }

    closeSolveModal() {
        this.dom.solveModal.classList.remove('active');
    }

    submitSolve() {
        if (!this.dom.solveInput) return;

        const guess = this.dom.solveInput.value.trim();
        if (!guess) {
            // Ignore empty submissions; keep the modal open and do nothing.
            return;
        }

        const q = this.state.questions[this.state.currentIndex];
        const answer = q.title;
        
        this.closeSolveModal();
        
        if (this.isFuzzyMatch(guess, answer)) {
            this.handleCorrect();
        } else {
            this.handleIncorrect();
        }
    }

    handleCorrect() {
        const q = this.state.questions[this.state.currentIndex];
        const points = this.state.currentPot;
        
        this.state.results.push({ title: q.title, points, correct: true });
        this.state.totalScore += points;
        this.updateTotalScore();
        
        const displayTitle = this.getDisplayTitle(q.title).toUpperCase();
        displayTitle.split('').forEach((char, i) => {
            if (/[A-Z0-9]/.test(char)) {
                this.state.revealedIndices.push(i);
            }
        });
        this.renderTitle();
        
        this.showResult(true, q.title, points);
        
        try {
            if (typeof confetti === 'function') {
                confetti({
                    particleCount: 80,
                    spread: 60,
                    origin: { y: 0.6 },
                    colors: ['#d4a853', '#f0d078', '#ffffff'],
                    disableForReducedMotion: true
                });
            }
        } catch (e) {}
    }

    handleIncorrect() {
        const q = this.state.questions[this.state.currentIndex];
        
        this.state.strikes--;
        this.updateStrikes();
        
        this.dom.clueCard.classList.add('shake');
        setTimeout(() => this.dom.clueCard.classList.remove('shake'), 400);
        
        if (this.state.strikes <= 0) {
            this.state.results.push({ title: q.title, points: 0, correct: false });
            this.showResult(false, q.title, 0, true);
        } else {
            this.showResult(false, q.title, 0, false);
        }
    }

    showResult(isCorrect, title, points, isGameOver = false, gaveUp = false) {
        const resultCard = document.querySelector('.result-card');
        resultCard.classList.remove('celebrate');

        const commentary = this.getRoastMessage(isCorrect);

        this.dom.resultIcon.textContent = isCorrect ? 'üé¨' : (gaveUp ? 'üè≥Ô∏è' : '‚ùå');
        this.dom.resultTitle.textContent = commentary;
        this.dom.resultTitle.className = `result-title ${isCorrect ? 'correct' : 'incorrect'}`;
        
        if (isCorrect || gaveUp || isGameOver) {
            this.dom.resultMovie.textContent = title.toUpperCase();
            this.dom.resultMovie.style.display = 'block';
        } else {
            this.dom.resultMovie.style.display = 'none';
        }
        
        if (isCorrect) {
            resultCard.classList.add('celebrate');
            this.dom.resultPoints.textContent = `+${points} points`;
            this.dom.resultPoints.className = 'result-points';
        } else if (isGameOver) {
            this.dom.resultPoints.textContent = 'Out of strikes!';
            this.dom.resultPoints.className = 'result-points zero';
        } else if (gaveUp) {
            this.dom.resultPoints.textContent = '0 points';
            this.dom.resultPoints.className = 'result-points zero';
        } else {
            this.dom.resultPoints.textContent = `${this.state.strikes} strike${this.state.strikes !== 1 ? 's' : ''} remaining`;
            this.dom.resultPoints.className = 'result-points zero';
        }
        
        if (!isCorrect && !isGameOver && !gaveUp) {
            this.dom.continueBtn.textContent = 'Try Again';
            this.dom.continueBtn.onclick = () => {
                this.dom.resultOverlay.classList.remove('active');
            };
        } else {
            this.dom.continueBtn.textContent = 'Continue';
            this.dom.continueBtn.onclick = () => {
                this.dom.resultOverlay.classList.remove('active');
                if (isGameOver) {
                    this.endGame();
                } else {
                    this.nextQuestion();
                }
            };
        }
        
        this.dom.resultOverlay.classList.add('active');
    }

    getRoastMessage(isCorrect) {
        const mode = this.settings?.roastMode || 'clean';
        const praiseList = PRAISE_MESSAGES[mode] && PRAISE_MESSAGES[mode].length
            ? PRAISE_MESSAGES[mode]
            : PRAISE_MESSAGES.clean;
        const insultList = INSULT_MESSAGES[mode] && INSULT_MESSAGES[mode].length
            ? INSULT_MESSAGES[mode]
            : INSULT_MESSAGES.clean;
        const list = isCorrect ? praiseList : insultList;

        if (!list.length) {
            return isCorrect ? 'Nice work!' : 'Good try!';
        }

        const index = Math.floor(Math.random() * list.length);
        return list[index];
    }

    nextQuestion() {
        this.state.currentIndex++;
        
        if (this.state.currentIndex >= this.state.questions.length) {
            this.endGame();
        } else {
            this.loadQuestion();
        }
    }

    endGame() {
        const solved = this.state.results.filter(r => r.correct).length;
        const total = this.state.results.length;
        
        this.stats.totalSolved += solved;
        this.stats.totalPlayed += total;
        this.stats.currentStreak = solved === total ? this.stats.currentStreak + solved : 0;
        this.stats.bestStreak = Math.max(this.stats.bestStreak, this.stats.currentStreak);
        if (this.state.totalScore > this.stats.highScore) {
            this.stats.highScore = this.state.totalScore;
        }
        this.saveStats();
        this.updateStatsDisplay();
        
        this.dom.finalScore.textContent = this.state.totalScore;
        this.dom.finalSubtitle.textContent = `${solved} of ${total} movies solved`;
        
        this.dom.finalBreakdown.innerHTML = '';
        this.state.results.forEach(r => {
            const row = document.createElement('div');
            row.className = 'breakdown-row';
            row.innerHTML = `
                <span class="breakdown-title">${r.title}</span>
                <span class="breakdown-points ${r.correct ? 'earned' : 'missed'}">
                    ${r.correct ? '+' + r.points : '‚Äî'}
                </span>
            `;
            this.dom.finalBreakdown.appendChild(row);
        });
        
        this.showScreen('gameOver');
    }
    
    shareScore() {
        const solved = this.state.results.filter(r => r.correct).length;
        const total = this.state.results.length;
        const category = this.state.selectedCategory;
        
        const emoji = this.state.results.map(r => {
            if (r.correct) return 'üü©';
            if (r.gaveUp) return 'üü®';
            return 'üü•';
        }).join('');
        
        const text = `üé¨ Plot Twisted - ${category}
üèÜ Score: ${this.state.totalScore}
${emoji}
${solved}/${total} correct

Can you beat my score?`;
        
        if (navigator.share) {
            navigator.share({ text }).catch(() => this.copyToClipboard(text));
        } else {
            this.copyToClipboard(text);
        }
    }
    
    copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            alert('Score copied to clipboard! üìã');
        }).catch(() => {
            alert('Could not copy to clipboard');
        });
    }

    playAgain() {
        if (this.state.selectedCategory) {
            this.startGame();
        } else {
            this.showCategoryScreen();
        }
    }

    updatePot(animate = false) {
        if (animate) {
            this.dom.potValue.classList.add('dropping');
            setTimeout(() => this.dom.potValue.classList.remove('dropping'), 300);
        }
        this.dom.potValue.textContent = this.state.currentPot;
    }

    updateTotalScore() {
        this.dom.totalScore.textContent = this.state.totalScore;
    }

    updateStrikes() {
        const pips = this.dom.strikesDisplay.querySelectorAll('.strike-pip');
        pips.forEach((pip, i) => {
            pip.classList.toggle('used', i >= this.state.strikes);
        });
    }

    renderProgress() {
        this.dom.progressTrack.innerHTML = '';
        for (let i = 0; i < this.config.questionsPerRound; i++) {
            const pip = document.createElement('div');
            pip.className = 'progress-pip';
            this.dom.progressTrack.appendChild(pip);
        }
    }

    updateProgress() {
        const pips = this.dom.progressTrack.querySelectorAll('.progress-pip');
        pips.forEach((pip, i) => {
            pip.classList.remove('current', 'complete');
            if (i < this.state.currentIndex) {
                pip.classList.add('complete');
            } else if (i === this.state.currentIndex) {
                pip.classList.add('current');
            }
        });
    }

    updateStatsDisplay() {
        const statContainer = this.dom.statSolved?.closest('.stat-item');
        if (statContainer && statContainer.style.display === 'none') {
            return;
        }
        this.dom.statSolved.textContent = this.stats.totalSolved;
        const accuracy = this.stats.totalPlayed > 0 
            ? Math.round((this.stats.totalSolved / this.stats.totalPlayed) * 100) 
            : 0;
        this.dom.statAccuracy.textContent = accuracy + '%';
        this.dom.statStreak.textContent = this.stats.bestStreak;
    }

    hideTrackingUI() {
        [this.dom.statSolved, this.dom.statAccuracy, this.dom.statStreak].forEach((stat) => {
            const item = stat?.closest('.stat-item');
            if (item) {
                item.style.display = 'none';
            }
        });

        const resetRow = this.dom.resetBtn?.closest('.setting-row');
        if (resetRow) {
            resetRow.style.display = 'none';
        } else if (this.dom.resetBtn) {
            this.dom.resetBtn.style.display = 'none';
        }
    }

    startHomeQuoteRotator() {
        if (!this.dom.homeQuoteRotator || !this.dom.homeQuoteText) return;

        this.dom.homeQuoteRotator.style.display = '';
        this.stopHomeQuoteRotator();

        this.quoteIndex = Math.floor(Math.random() * HOME_QUOTES.length);
        this.renderHomeQuote();

        this.quoteInterval = setInterval(() => {
            this.quoteIndex = (this.quoteIndex + 1) % HOME_QUOTES.length;
            this.renderHomeQuote();
        }, 6000);
    }

    stopHomeQuoteRotator() {
        if (this.quoteInterval) {
            clearInterval(this.quoteInterval);
            this.quoteInterval = null;
        }
    }

    renderHomeQuote() {
        const item = HOME_QUOTES[this.quoteIndex];
        if (!item) return;

        this.dom.homeQuoteText.textContent = `‚Äú${item.quote}‚Äù`;
        if (this.dom.homeQuoteSource) {
            this.dom.homeQuoteSource.textContent = `‚Äî ${item.source}`;
        }
    }

    loadStats() {
        const saved = localStorage.getItem('plotTwistedStats');
        return this.safeJsonParse(saved, {
            totalSolved: 0,
            totalPlayed: 0,
            bestStreak: 0,
            currentStreak: 0,
            highScore: 0
        }, 'stats');
    }

    saveStats() {
        localStorage.setItem('plotTwistedStats', JSON.stringify(this.stats));
    }

    loadSeenClues() {
        const saved = localStorage.getItem('plotTwistedSeen');
        this.state.seenClues = this.safeJsonParse(saved, {}, 'seen clues');
    }

    saveSeenClues() {
        localStorage.setItem('plotTwistedSeen', JSON.stringify(this.state.seenClues));
    }

    getUnseenCount(category) {
        if (!this.clueBank || !this.clueBank[category]) return 0;
        const total = this.clueBank[category].length;
        const seen = (this.state.seenClues[category] || []).length;
        return Math.max(0, total - seen);
    }

    shuffle(arr) {
        const a = [...arr];
        for (let i = a.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [a[i], a[j]] = [a[j], a[i]];
        }
        return a;
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    const game = new PlotTwisted();
    game.init();
});
</script>
</body>
</html>
